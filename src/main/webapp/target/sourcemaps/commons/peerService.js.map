{"version":3,"sources":["commons/peerService.js"],"names":[],"mappings":"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","file":"../../commons/peerService.js","sourcesContent":["/**\n * Created by Alexandru on 29/02/16.\n */\nimport {Service} from \"/ngDecorators\"\nimport socketService from '/commons/socketService';\nimport adapter from \"webrtc-adapter\";\nimport {window} from \"./externalServices\"\nimport authService from '/commons/authService';\n\n@Service({serviceName: 'peerService'})\nclass PeerService {\n\n    constructor() {\n\n    }\n\n\n    connect(remoteStreamHandler){\n        this.peer = new RTCPeerConnection(null);\n        this.peer.onicecandidate = this.iceCandidateLocal.bind(this);\n        this.remotePeer = new RTCPeerConnection(null);\n        this.remotePeer.onaddstream = remoteStreamHandler;\n        this.remotePeer.onicecandidate = this.iceCandidateRemote.bind(this);\n        this.subscribeToOffer(this.gotOffer.bind(this));\n        this.sdpConstraints = {'mandatory': {\n            'OfferToReceiveAudio':true,\n            'OfferToReceiveVideo':true }};\n    }\n\n    iceCandidateRemote(event){\n        if (event.candidate) {\n            this.peer.addIceCandidate(new RTCIceCandidate(event.candidate));\n        }\n    }\n\n    iceCandidateLocal(event){\n        if (event.candidate) {\n            this.remotePeer.addIceCandidate(new RTCIceCandidate(event.candidate));\n        }\n    }\n\n    gotOffer(data){\n        console.log(\"got offer\");\n        data = JSON.parse(data.body);\n        this.rtcSessionDesc = new RTCSessionDescription();\n        this.rtcSessionDesc.type = \"offer\";\n        this.rtcSessionDesc.sdp = data.sdpDescription;\n        this.remotePeer.setLocalDescription(this.rtcSessionDesc);\n        this.peer.setRemoteDescription(this.rtcSessionDesc)\n        this.answer(data.id)\n    }\n\n    gotAnswer(data){\n        console.log(\"got Answer\");\n        data = JSON.parse(data.body);\n        let rtcSessionDesc = new RTCSessionDescription();\n        rtcSessionDesc.type = \"answer\";\n        rtcSessionDesc.sdp = data.sdpDescription;\n        this.remotePeer.setLocalDescription(rtcSessionDesc);\n        this.peer.setRemoteDescription(rtcSessionDesc)\n    }\n\n    getUserMedia(){\n        return window().navigator.mediaDevices.getUserMedia({video:true, audio:false});\n    }\n\n    setLocalStream(localstream){\n        this.peer.addStream(localstream);\n    }\n\n    sendMessage(text) {\n\n    }\n\n    call(username){\n        /*\n        this.peer.sendOffer(this.offerHandler);\n*/\n       this.peer.sendOffer()\n            .then(offer => this.offerHandler(offer, username));\n    }\n\n    answer(username){\n        /*\n        this.peer.createAnswer(function(desc){\n            this.handlerReceiveAnswer(desc, username)\n        }.bind(this), this.handleError);\n        */\n        this.peer.createAnswer()\n            .then(offer => this.answerHandler(offer, username));\n    }\n\n    offerHandler(desc, username){\n        console.log(\"creating SDP offer\");\n        console.log(\"sdp : \"+desc.sdp);\n        this.peer.setLocalDescription(desc);\n        this.remotePeer.setRemoteDescription(desc);\n        socketService().send({id:authService().getUsername(), type: 'offer', sdpDescription:desc.sdp, destUsername: username});\n        this.subscribeToAnswer(this.gotAnswer.bind(this));\n    }\n\n    answerHandler(desc, username){\n        console.log(\"creating SDP offer\");\n        this.peer.setLocalDescription(desc);\n        this.remotePeer.setRemoteDescription(desc);\n        socketService().send({id:authService().getUsername(), type: 'answer', sdpDescription:desc.sdp, destUsername: username});\n    }\n\n    //$q\n    //$q.all (merge promises)\n    subscribeToAnswer(handler){\n        /**\n        return $q(function(succes, error){\n            socketService().subscribe(\"/topic/\"+authService().getUsername()+\"/sdpAnswer\", success);\n        })*/\n        return socketService().subscribe(\"/topic/\"+authService().getUsername()+\"/sdpAnswer\", handler);\n    }\n\n    subscribeToOffer(handler){\n        return socketService().subscribe(\"/topic/\"+authService().getUsername()+\"/sdpOffer\", handler);\n    }\n    handleError(errmsg) {\n        console.log(\"handleError: \" + errmsg);\n    }\n}\nexport default PeerService.instance;"],"sourceRoot":"/"}